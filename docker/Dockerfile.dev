FROM eclipse-temurin:23-jdk AS build
WORKDIR /app

# Cache deps
COPY mvnw ./
COPY .mvn .mvn
COPY pom.xml ./
RUN chmod +x mvnw && ./mvnw -q dependency:go-offline

# Build
COPY src ./src
RUN ./mvnw -q -DskipTests package

# ---- Runtime ----
FROM eclipse-temurin:23-jre
WORKDIR /app
RUN useradd -r -u 10001 appuser

COPY --from=build /app/target/*.jar /app/app.jar
RUN mkdir -p /app/data/uploads/profiles /var/log/oauth-app && \
    chown -R appuser:appuser /app /var/log/oauth-app

ENV SERVER_PORT=8080 SPRING_PROFILES_ACTIVE=dev JAVA_OPTS="-Xms256m -Xmx512m"
EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=3s --retries=3 \
  CMD curl -fsS http://localhost:8080/actuator/health || exit 1

USER appuser
ENTRYPOINT ["sh","-c","java $JAVA_OPTS -jar /app/app.jar --server.port=${SERVER_PORT} --spring.profiles.active=${SPRING_PROFILES_ACTIVE}"]
